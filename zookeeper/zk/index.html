
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="MkDocs Material Boilerplate (Starter Kit) - Deploy documentation to hosting platforms (Netlify, GitHub Pages, GitLab Pages, and AWS Amplify Console) with Docker, pipenv, and GitHub Actions.">
      
      
      
        <meta name="author" content="nitto">
      
      
        <link rel="canonical" href="https://nitto.netlify.app/zookeeper/zk/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.1, mkdocs-material-7.1.9">
    
    
      
        <title>项目一前置课-Zookeeper - Nitto Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.ca7ac06f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.f1a3b89f.min.css">
        
          
          
          <meta name="theme-color" content="#2094f3">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
      <link rel="manifest" href="../../manifest.json" crossorigin="use-credentials">
    
    
      <link rel="stylesheet" href="../../assets/css/custom.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue" data-md-color-accent="blue">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#zookeeper" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Nitto Docs" class="md-header__button md-logo" aria-label="Nitto Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Nitto Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              项目一前置课-Zookeeper
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/Zfqwb/mkdocs/" title="前往 GitHub 仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Nitto Docs" class="md-nav__button md-logo" aria-label="Nitto Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Nitto Docs
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/Zfqwb/mkdocs/" title="前往 GitHub 仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../MySQL.md" class="md-nav__link">
        Mysql
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../jquery/" class="md-nav__link">
        JQuery
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../ajax/" class="md-nav__link">
        AJAX
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      <label class="md-nav__link" for="__nav_5">
        Redis
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Redis" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Redis
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/day01/" class="md-nav__link">
        day01
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/day02/" class="md-nav__link">
        day02
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      <label class="md-nav__link" for="__nav_6">
        Docker
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Docker" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Docker
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/1/" class="md-nav__link">
        初识 Docker
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/2/" class="md-nav__link">
        docker命令
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/3/" class="md-nav__link">
        docker容器的数据卷
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/4/" class="md-nav__link">
        docker部署容器
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/5/" class="md-nav__link">
        Docerfile
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/6/" class="md-nav__link">
        服务编排
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../docker/7/" class="md-nav__link">
        私有仓库
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../MongoDB/MongoDB/" class="md-nav__link">
        MongoDB
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      <label class="md-nav__link" for="__nav_8">
        项目一-探花交友
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="项目一-探花交友" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          项目一-探花交友
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tantan/day01/README.md" class="md-nav__link">
        day01
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tantan/day02/README.md" class="md-nav__link">
        day02
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tantan/day03/README.md" class="md-nav__link">
        day03
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tantan/day04/README.md" class="md-nav__link">
        day04
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tantan/day05/README.md" class="md-nav__link">
        day05
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tantan/day06/README.md" class="md-nav__link">
        day06
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tantan/day07/README.md" class="md-nav__link">
        day07
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tantan/day08/README.md" class="md-nav__link">
        day08
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tantan/day09/README.md" class="md-nav__link">
        day09
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tantan/day10/README.md" class="md-nav__link">
        day10
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8_11" type="checkbox" id="__nav_8_11" >
      
      <label class="md-nav__link" for="__nav_8_11">
        补充资料
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="补充资料" data-md-level="2">
        <label class="md-nav__title" for="__nav_8_11">
          <span class="md-nav__icon md-icon"></span>
          补充资料
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tantan/further/lombok/README.md" class="md-nav__link">
        day01_lombok
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tantan/further/mybatisPlus/README.md" class="md-nav__link">
        day01_mybatis_plus
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tantan/further/aliyun/README.md" class="md-nav__link">
        day01_阿里云
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tantan/further/sso/README.md" class="md-nav__link">
        day01_单点登录及jwt
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tantan/further/nginx/README.md" class="md-nav__link">
        day03_nginx
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tantan/further/threadlocal/README.md" class="md-nav__link">
        day03_ThreadLocal
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tantan/further/mongodb/README.md" class="md-nav__link">
        day04_MongoDB
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../tantan/further/ansy/README.md" class="md-nav__link">
        day04_多线程@Ansy
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      <label class="md-nav__link" for="__nav_9">
        项目二-黑马头条
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="项目二-黑马头条" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          项目二-黑马头条
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hmtt/day01/README.md" class="md-nav__link">
        day01
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hmtt/day02/README.md" class="md-nav__link">
        day02
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hmtt/day03/README.md" class="md-nav__link">
        day03
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hmtt/day04/README.md" class="md-nav__link">
        day04
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hmtt/day05/README.md" class="md-nav__link">
        day05
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hmtt/day06/README.md" class="md-nav__link">
        day06
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hmtt/day07/README.md" class="md-nav__link">
        day07
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hmtt/day08/README.md" class="md-nav__link">
        day08
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hmtt/day09/README.md" class="md-nav__link">
        day09
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hmtt/day10/README.md" class="md-nav__link">
        day10
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hmtt/day11/README.md" class="md-nav__link">
        day11
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hmtt/day12/README.md" class="md-nav__link">
        day12
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hmtt/day13/README.md" class="md-nav__link">
        day13
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hmtt/day14/README.md" class="md-nav__link">
        day14
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hmtt/day15/README.md" class="md-nav__link">
        day15
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_10" type="checkbox" id="__nav_10" >
      
      <label class="md-nav__link" for="__nav_10">
        面试
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="面试" data-md-level="1">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          面试
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../interview/e.g.1.0.0.md" class="md-nav__link">
        e.g.1.0.0
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1_zookeeper" class="md-nav__link">
    1)初识 Zookeeper
  </a>
  
    <nav class="md-nav" aria-label="1)初识 Zookeeper">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11zookeeper" class="md-nav__link">
    1.1)Zookeeper概念
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2zookeeper" class="md-nav__link">
    2)ZooKeeper 安装与配置
  </a>
  
    <nav class="md-nav" aria-label="2)ZooKeeper 安装与配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21" class="md-nav__link">
    2.1) 下载安装
  </a>
  
    <nav class="md-nav" aria-label="2.1) 下载安装">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#211" class="md-nav__link">
    2.1.1、环境准备
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#212" class="md-nav__link">
    2.1.2、上传
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#213" class="md-nav__link">
    2.1.3、解压
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22" class="md-nav__link">
    2.2) 配置启动
  </a>
  
    <nav class="md-nav" aria-label="2.2) 配置启动">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#221zoocfg" class="md-nav__link">
    2.2.1、配置zoo.cfg
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#222zookeeper" class="md-nav__link">
    2.2.2、启动ZooKeeper
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3zookeeper" class="md-nav__link">
    3)ZooKeeper 命令操作
  </a>
  
    <nav class="md-nav" aria-label="3)ZooKeeper 命令操作">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31zookeeper" class="md-nav__link">
    3.1)Zookeeper命令操作数据模型
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32zookeeper" class="md-nav__link">
    3.2)Zookeeper命令操作服务端命令
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33zookeeper" class="md-nav__link">
    3.3)Zookeeper客户端常用命令
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-" class="md-nav__link">
    3.4)客户端命令-创建临时有序节点
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4zookeeper_javaapi" class="md-nav__link">
    4)ZooKeeper JavaAPI 操作
  </a>
  
    <nav class="md-nav" aria-label="4)ZooKeeper JavaAPI 操作">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41urator" class="md-nav__link">
    4.1)urator介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42javaapi" class="md-nav__link">
    4.2)JavaAPI操作建立连接
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43zookeeper_javaapi-" class="md-nav__link">
    4.3)Zookeeper JavaAPI操作-创建节点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44zookeeperjavaapi-" class="md-nav__link">
    4.4)ZookeeperJavaAPI操作-查询节点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45zookeeper_javaapi-" class="md-nav__link">
    4.5)Zookeeper JavaAPI操作-修改节点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#46zookeeper_javaapi-" class="md-nav__link">
    4.6)Zookeeper JavaAPI操作-删除节点
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#47zookeeper_javaapi-watch" class="md-nav__link">
    4.7)Zookeeper JavaAPI操作-Watch监听概述
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#48zookeeper_javaapi-watch-nodecache" class="md-nav__link">
    4.8Zookeeper JavaAPI操作-Watch监听-NodeCache
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#49zookeeper_javaapi-watch-pathchildrencache" class="md-nav__link">
    4.9)Zookeeper JavaAPI操作-Watch监听-PathChildrenCache
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#410zookeeper_javaapi-watch-treecache" class="md-nav__link">
    4.10)Zookeeper JavaAPI操作-Watch监听-TreeCache
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#411zookeeper-" class="md-nav__link">
    4.11)Zookeeper分布式锁-概念
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#412zookeeper_-zookeeper" class="md-nav__link">
    4.12)Zookeeper 分布式锁-zookeeper分布式锁原理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#413zookeeper_-12306" class="md-nav__link">
    4.13)Zookeeper 分布式锁-模拟12306售票案例
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5zookeeper" class="md-nav__link">
    5)ZooKeeper 集群搭建
  </a>
  
    <nav class="md-nav" aria-label="5)ZooKeeper 集群搭建">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51zookeeper" class="md-nav__link">
    5.1)Zookeeper集群介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52" class="md-nav__link">
    5.2)搭建要求
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53" class="md-nav__link">
    5.3)准备工作
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#54" class="md-nav__link">
    5.4)配置集群
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#55" class="md-nav__link">
    5.5)启动集群
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#56" class="md-nav__link">
    5.6)模拟集群异常
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6zookeeper" class="md-nav__link">
    6)Zookeeper 核心理论
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/Zfqwb/mkdocs/edit/main/docs_sample/zookeeper/zk.md" title="编辑此页" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="zookeeper">Zookeeper<a class="headerlink" href="#zookeeper" title="Permanent link">&para;</a></h1>
<h2 id="1_zookeeper">1)初识 Zookeeper<a class="headerlink" href="#1_zookeeper" title="Permanent link">&para;</a></h2>
<h3 id="11zookeeper">1.1)Zookeeper概念<a class="headerlink" href="#11zookeeper" title="Permanent link">&para;</a></h3>
<p>•Zookeeper 是 Apache Hadoop 项目下的一个子项目，是一个树形目录服务。</p>
<p>•Zookeeper 翻译过来就是 动物园管理员，他是用来管 Hadoop（大象）、Hive(蜜蜂)、Pig(小 猪)的管理员。简称zk</p>
<p>•Zookeeper 是一个分布式的、开源的分布式应用程序的协调服务。</p>
<p>•Zookeeper 提供的主要功能包括：</p>
<p>•配置管理</p>
<p>•分布式锁</p>
<p>•集群管理</p>
<p><img alt="1592054580488" src="assets\1592054580488.png" /></p>
<p><img alt="1592054603167" src="assets\1592054603167.png" /></p>
<h2 id="2zookeeper">2)ZooKeeper 安装与配置<a class="headerlink" href="#2zookeeper" title="Permanent link">&para;</a></h2>
<h3 id="21">2.1) 下载安装<a class="headerlink" href="#21" title="Permanent link">&para;</a></h3>
<h4 id="211"><strong>2.1.1、环境准备</strong><a class="headerlink" href="#211" title="Permanent link">&para;</a></h4>
<p>ZooKeeper服务器是用Java创建的，它运行在JVM之上。需要安装JDK 7或更高版本。</p>
<h4 id="212"><strong>2.1.2、上传</strong><a class="headerlink" href="#212" title="Permanent link">&para;</a></h4>
<p>将下载的ZooKeeper放到/opt/ZooKeeper目录下</p>
<div class="codehilite"><pre><span></span><code><span class="c1">#上传zookeeper alt+p</span>
put f:/setup/apache-zookeeper-3.5.6-bin.tar.gz
<span class="c1">#打开 opt目录</span>
<span class="nb">cd</span> /opt
<span class="c1">#创建zooKeeper目录</span>
mkdir  zooKeeper
<span class="c1">#将zookeeper安装包移动到 /opt/zooKeeper</span>
mv apache-zookeeper-3.5.6-bin.tar.gz /opt/zookeeper/
</code></pre></div>

<h4 id="213"><strong>2.1.3、解压</strong><a class="headerlink" href="#213" title="Permanent link">&para;</a></h4>
<p>将tar包解压到/opt/zookeeper目录下</p>
<div class="codehilite"><pre><span></span><code>tar -zxvf apache-ZooKeeper-3.5.6-bin.tar.gz 
</code></pre></div>

<h3 id="22">2.2) 配置启动<a class="headerlink" href="#22" title="Permanent link">&para;</a></h3>
<h4 id="221zoocfg"><strong>2.2.1、配置zoo.cfg</strong><a class="headerlink" href="#221zoocfg" title="Permanent link">&para;</a></h4>
<p>进入到conf目录拷贝一个zoo_sample.cfg并完成配置</p>
<div class="codehilite"><pre><span></span><code><span class="c1">#进入到conf目录</span>
<span class="nb">cd</span> /opt/zooKeeper/apache-zooKeeper-3.5.6-bin/conf/
<span class="c1">#拷贝</span>
cp  zoo_sample.cfg  zoo.cfg
</code></pre></div>

<p>修改zoo.cfg</p>
<div class="codehilite"><pre><span></span><code><span class="c1">#打开目录</span>
<span class="nb">cd</span> /opt/zooKeeper/
<span class="c1">#创建zooKeeper存储目录</span>
mkdir  zkdata
<span class="c1">#修改zoo.cfg</span>
vim /opt/zooKeeper/apache-zooKeeper-3.5.6-bin/conf/zoo.cfg
</code></pre></div>

<p><img alt="1577548250377" src="../assets/1577548250377.png" /></p>
<p>修改存储目录：dataDir=/opt/zookeeper/zkdata</p>
<h4 id="222zookeeper"><strong>2.2.2、启动ZooKeeper</strong><a class="headerlink" href="#222zookeeper" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="nb">cd</span> /opt/zooKeeper/apache-zooKeeper-3.5.6-bin/bin/
<span class="c1">#启动</span>
 ./zkServer.sh  start
</code></pre></div>

<p><img alt="1577548052037" src="../assets/1577548052037.png" /></p>
<p>看到上图表示ZooKeeper成功启动</p>
<p><strong>3、查看ZooKeeper状态</strong></p>
<div class="codehilite"><pre><span></span><code>./zkServer.sh status
</code></pre></div>

<p>zookeeper启动成功。standalone代表zk没有搭建集群，现在是单节点</p>
<p><img alt="1577548175232" src="../assets/1577548175232.png" /></p>
<p>zookeeper没有启动</p>
<p><img alt="1577548112773" src="../assets/1577548112773.png" /></p>
<h3 id="_1"><a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<h2 id="3zookeeper">3)ZooKeeper 命令操作<a class="headerlink" href="#3zookeeper" title="Permanent link">&para;</a></h2>
<h3 id="31zookeeper">3.1)Zookeeper命令操作数据模型<a class="headerlink" href="#31zookeeper" title="Permanent link">&para;</a></h3>
<p>•ZooKeeper 是一个树形目录服务,其数据模型和Unix的文件系统目录树很类似，拥有一个层次化结构。</p>
<p>•这里面的每一个节点都被称为： ZNode，每个节点上都会保存自己的数据和节点信息。 </p>
<p>• 节点可以拥有子节点，同时也允许少量（1MB）数据存储在该节点之下。</p>
<p>•节点可以分为四大类：</p>
<p>•PERSISTENT 持久化节点 </p>
<p>•EPHEMERAL 临时节点 ：-e</p>
<p>•PERSISTENT_SEQUENTIAL 持久化顺序节点 ：-s</p>
<p>•EPHEMERAL_SEQUENTIAL 临时顺序节点  ：-es</p>
<p><img alt="1592054828485" src="../assets/1592054828485.png" /></p>
<p><img alt="1592054844023" src="../assets/1592054844023.png" /></p>
<h3 id="32zookeeper"><strong>3.2)Zookeeper命令操作服务端命令</strong><a class="headerlink" href="#32zookeeper" title="Permanent link">&para;</a></h3>
<p>•启动 ZooKeeper 服务: ./zkServer.sh start</p>
<p>•查看 ZooKeeper 服务状态: ./zkServer.sh status</p>
<p>•停止 ZooKeeper 服务: ./zkServer.sh stop </p>
<p>•重启 ZooKeeper 服务: ./zkServer.sh restart </p>
<p><img alt="1592055088686" src="assets\1592055088686.png" /></p>
<h3 id="33zookeeper"><strong>3.3)Zookeeper客户端常用命令</strong><a class="headerlink" href="#33zookeeper" title="Permanent link">&para;</a></h3>
<p>连接ZooKeeper服务端</p>
<div class="codehilite"><pre><span></span><code>./zkCli.sh –server ip:port
</code></pre></div>

<p>断开连接</p>
<div class="codehilite"><pre><span></span><code>quit
</code></pre></div>

<p>查看命令帮助</p>
<div class="codehilite"><pre><span></span><code><span class="nb">help</span>
</code></pre></div>

<p>显示指定目录下节点</p>
<div class="codehilite"><pre><span></span><code>ls 目录
</code></pre></div>

<p>创建节点</p>
<div class="codehilite"><pre><span></span><code>create /节点path value
</code></pre></div>

<p>获取节点值</p>
<div class="codehilite"><pre><span></span><code>get /节点path
</code></pre></div>

<p>设置节点值</p>
<div class="codehilite"><pre><span></span><code>set /节点path value
</code></pre></div>

<p>删除单个节点</p>
<div class="codehilite"><pre><span></span><code>delete /节点path
</code></pre></div>

<p>删除带有子节点的节点</p>
<div class="codehilite"><pre><span></span><code>deleteall /节点path
</code></pre></div>

<p><img alt="1592055332198" src="assets\1592055332198.png" /></p>
<p><img alt="1592055345400" src="assets\1592055345400.png" /></p>
<h3 id="34-">3.4)客户端命令-创建临时有序节点<a class="headerlink" href="#34-" title="Permanent link">&para;</a></h3>
<p>•创建临时节点</p>
<div class="codehilite"><pre><span></span><code>create -e /节点path value
</code></pre></div>

<p>•创建顺序节点</p>
<div class="codehilite"><pre><span></span><code>create -s /节点path value
</code></pre></div>

<p>•查询节点详细信息</p>
<div class="codehilite"><pre><span></span><code>ls –s /节点path 
</code></pre></div>

<p>•czxid：节点被创建的事务ID </p>
<p>•ctime: 创建时间 </p>
<p>•mzxid: 最后一次被更新的事务ID </p>
<p>•mtime: 修改时间 </p>
<p>•pzxid：子节点列表最后一次被更新的事务ID</p>
<p>•cversion：子节点的版本号 </p>
<p>•dataversion：数据版本号 </p>
<p>•aclversion：权限版本号 </p>
<p>•ephemeralOwner：用于临时节点，代表临时节点的事务ID，如果为持久节点则为0 </p>
<p>•dataLength：节点存储的数据的长度 </p>
<p>•numChildren：当前节点的子节点个数 </p>
<p><img alt="1592055462588" src="assets\1592055462588.png" /></p>
<h2 id="4zookeeper_javaapi">4)ZooKeeper JavaAPI 操作<a class="headerlink" href="#4zookeeper_javaapi" title="Permanent link">&para;</a></h2>
<h3 id="41urator">4.1)urator介绍<a class="headerlink" href="#41urator" title="Permanent link">&para;</a></h3>
<p>•Curator 是 Apache ZooKeeper 的Java客户端库。</p>
<p>•常见的ZooKeeper Java API ：</p>
<p>•原生Java API</p>
<p>•ZkClient</p>
<p>•Curator</p>
<p>•Curator 项目的目标是简化 ZooKeeper 客户端的使用。</p>
<p>•Curator 最初是 Netfix 研发的,后来捐献了 Apache 基金会,目前是 Apache 的顶级项目。</p>
<p>•官网：http://curator.apache.org/</p>
<h3 id="42javaapi">4.2)JavaAPI操作建立连接<a class="headerlink" href="#42javaapi" title="Permanent link">&para;</a></h3>
<p>1，搭建项目</p>
<p>创建项目curator-zk</p>
<p>引入pom和日志文件</p>
<p>资料文件夹下pom.xml和log4j.properties</p>
<p><img alt="1592055569716" src="assets\1592055569716.png" /></p>
<p>2、创建测试类，使用curator连接zookeeper</p>
<div class="codehilite"><pre><span></span><code><span class="nd">@Before</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testConnect</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//重试策略</span>
    <span class="n">RetryPolicy</span> <span class="n">retryPolicy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ExponentialBackoffRetry</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="c1">//2.第二种方式</span>
    <span class="c1">//CuratorFrameworkFactory.builder();</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">CuratorFrameworkFactory</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
        <span class="p">.</span><span class="na">connectString</span><span class="p">(</span><span class="s">&quot;192.168.200.130:2181&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="na">sessionTimeoutMs</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="p">.</span><span class="na">connectionTimeoutMs</span><span class="p">(</span><span class="mi">15</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="p">.</span><span class="na">retryPolicy</span><span class="p">(</span><span class="n">retryPolicy</span><span class="p">)</span>
        <span class="p">.</span><span class="na">namespace</span><span class="p">(</span><span class="s">&quot;itheima&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="na">build</span><span class="p">();</span>
    <span class="c1">//开启连接</span>
    <span class="n">client</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="43zookeeper_javaapi-">4.3)Zookeeper JavaAPI操作-创建节点<a class="headerlink" href="#43zookeeper_javaapi-" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm">* 创建节点：create 持久 临时 顺序 数据</span>
<span class="cm">* 1. 基本创建 ：create().forPath(&quot;&quot;)</span>
<span class="cm">* 2. 创建节点 带有数据:create().forPath(&quot;&quot;,data)</span>
<span class="cm">* 3. 设置节点的类型：create().withMode().forPath(&quot;&quot;,data)</span>
<span class="cm">* 4. 创建多级节点  /app1/p1 ：create().creatingParentsIfNeeded().forPath(&quot;&quot;,data)</span>
<span class="cm">*/</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCreate</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="c1">//2. 创建节点 带有数据</span>
    <span class="c1">//如果创建节点，没有指定数据，则默认将当前客户端的ip作为数据存储</span>
    <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">create</span><span class="p">().</span><span class="na">forPath</span><span class="p">(</span><span class="s">&quot;/app2&quot;</span><span class="p">,</span> <span class="s">&quot;hehe&quot;</span><span class="p">.</span><span class="na">getBytes</span><span class="p">());</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCreate2</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="c1">//1. 基本创建</span>
    <span class="c1">//如果创建节点，没有指定数据，则默认将当前客户端的ip作为数据存储</span>
    <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">create</span><span class="p">().</span><span class="na">forPath</span><span class="p">(</span><span class="s">&quot;/app1&quot;</span><span class="p">);</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
<span class="p">}</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCreate3</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="c1">//3. 设置节点的类型</span>
    <span class="c1">//默认类型：持久化</span>
    <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">create</span><span class="p">().</span><span class="na">withMode</span><span class="p">(</span><span class="n">CreateMode</span><span class="p">.</span><span class="na">EPHEMERAL</span><span class="p">).</span><span class="na">forPath</span><span class="p">(</span><span class="s">&quot;/app3&quot;</span><span class="p">);</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
<span class="p">}</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCreate4</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="c1">//4. 创建多级节点  /app1/p1</span>
    <span class="c1">//creatingParentsIfNeeded():如果父节点不存在，则创建父节点</span>
    <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">create</span><span class="p">().</span><span class="na">creatingParentsIfNeeded</span><span class="p">().</span><span class="na">forPath</span><span class="p">(</span><span class="s">&quot;/app4/p1&quot;</span><span class="p">);</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="44zookeeperjavaapi-">4.4)ZookeeperJavaAPI操作-查询节点<a class="headerlink" href="#44zookeeperjavaapi-" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm">* 查询节点：</span>
<span class="cm">* 1. 查询数据：get: getData().forPath()</span>
<span class="cm">* 2. 查询子节点： ls: getChildren().forPath()</span>
<span class="cm">* 3. 查询节点状态信息：ls -s:getData().storingStatIn(状态对象).forPath()</span>
<span class="cm">*/</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testGet1</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="c1">//1. 查询数据：get</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">getData</span><span class="p">().</span><span class="na">forPath</span><span class="p">(</span><span class="s">&quot;/app1&quot;</span><span class="p">);</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="k">new</span> <span class="n">String</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testGet2</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="c1">// 2. 查询子节点： ls</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">path</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="na">getChildren</span><span class="p">().</span><span class="na">forPath</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">);</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
<span class="p">}</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testGet3</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="n">Stat</span> <span class="n">status</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Stat</span><span class="p">();</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
    <span class="c1">//3. 查询节点状态信息：ls -s</span>
    <span class="n">client</span><span class="p">.</span><span class="na">getData</span><span class="p">().</span><span class="na">storingStatIn</span><span class="p">(</span><span class="n">status</span><span class="p">).</span><span class="na">forPath</span><span class="p">(</span><span class="s">&quot;/app1&quot;</span><span class="p">);</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="45zookeeper_javaapi-">4.5)Zookeeper JavaAPI操作-修改节点<a class="headerlink" href="#45zookeeper_javaapi-" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm">* 修改数据</span>
<span class="cm">* 1. 基本修改数据：setData().forPath()</span>
<span class="cm">* 2. 根据版本修改: setData().withVersion().forPath()</span>
<span class="cm">* * version 是通过查询出来的。目的就是为了让其他客户端或者线程不干扰我。</span>
<span class="cm">*</span>
<span class="cm">* @throws Exception</span>
<span class="cm">*/</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSet</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="n">client</span><span class="p">.</span><span class="na">setData</span><span class="p">().</span><span class="na">forPath</span><span class="p">(</span><span class="s">&quot;/app1&quot;</span><span class="p">,</span> <span class="s">&quot;itcast&quot;</span><span class="p">.</span><span class="na">getBytes</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSetForVersion</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="n">Stat</span> <span class="n">status</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Stat</span><span class="p">();</span>
    <span class="c1">//3. 查询节点状态信息：ls -s</span>
    <span class="n">client</span><span class="p">.</span><span class="na">getData</span><span class="p">().</span><span class="na">storingStatIn</span><span class="p">(</span><span class="n">status</span><span class="p">).</span><span class="na">forPath</span><span class="p">(</span><span class="s">&quot;/app1&quot;</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">version</span> <span class="o">=</span> <span class="n">status</span><span class="p">.</span><span class="na">getVersion</span><span class="p">();</span><span class="c1">//查询出来的 3</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">version</span><span class="p">);</span>
    <span class="n">client</span><span class="p">.</span><span class="na">setData</span><span class="p">().</span><span class="na">withVersion</span><span class="p">(</span><span class="n">version</span><span class="p">).</span><span class="na">forPath</span><span class="p">(</span><span class="s">&quot;/app1&quot;</span><span class="p">,</span> <span class="s">&quot;hehe&quot;</span><span class="p">.</span><span class="na">getBytes</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="46zookeeper_javaapi-">4.6)Zookeeper JavaAPI操作-删除节点<a class="headerlink" href="#46zookeeper_javaapi-" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm">* 删除节点： delete deleteall</span>
<span class="cm">* 1. 删除单个节点:delete().forPath(&quot;/app1&quot;);</span>
<span class="cm">* 2. 删除带有子节点的节点:delete().deletingChildrenIfNeeded().forPath(&quot;/app1&quot;);</span>
<span class="cm">* 3. 必须成功的删除:为了防止网络抖动。本质就是重试。  client.delete().guaranteed().forPath(&quot;/app2&quot;);</span>
<span class="cm">* 4. 回调：inBackground</span>
<span class="cm">* @throws Exception</span>
<span class="cm">*/</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDelete</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="c1">// 1. 删除单个节点</span>
    <span class="n">client</span><span class="p">.</span><span class="na">delete</span><span class="p">().</span><span class="na">forPath</span><span class="p">(</span><span class="s">&quot;/app1&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDelete2</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="c1">//2. 删除带有子节点的节点</span>
    <span class="n">client</span><span class="p">.</span><span class="na">delete</span><span class="p">().</span><span class="na">deletingChildrenIfNeeded</span><span class="p">().</span><span class="na">forPath</span><span class="p">(</span><span class="s">&quot;/app4&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDelete3</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="c1">//3. 必须成功的删除</span>
    <span class="n">client</span><span class="p">.</span><span class="na">delete</span><span class="p">().</span><span class="na">guaranteed</span><span class="p">().</span><span class="na">forPath</span><span class="p">(</span><span class="s">&quot;/app2&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDelete4</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="c1">//4. 回调</span>
    <span class="n">client</span><span class="p">.</span><span class="na">delete</span><span class="p">().</span><span class="na">guaranteed</span><span class="p">().</span><span class="na">inBackground</span><span class="p">(</span><span class="k">new</span> <span class="n">BackgroundCallback</span><span class="p">(){</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processResult</span><span class="p">(</span><span class="n">CuratorFramework</span> <span class="n">client</span><span class="p">,</span> <span class="n">CuratorEvent</span> <span class="n">event</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;我被删除了~&quot;</span><span class="p">);</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}).</span><span class="na">forPath</span><span class="p">(</span><span class="s">&quot;/app1&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="47zookeeper_javaapi-watch">4.7)Zookeeper JavaAPI操作-Watch监听概述<a class="headerlink" href="#47zookeeper_javaapi-watch" title="Permanent link">&para;</a></h3>
<p>•ZooKeeper 允许用户在指定节点上注册一些Watcher，并且在一些特定事件触发的时候，ZooKeeper 服务端会将事件通知到感兴趣的客户端上去，该机制是 ZooKeeper 实现分布式协调服务的重要特性。</p>
<p>•ZooKeeper 中引入了Watcher机制来实现了发布/订阅功能能，能够让多个订阅者同时监听某一个对象，当一个对象自身状态变化时，会通知所有订阅者。</p>
<p>•ZooKeeper 原生支持通过注册Watcher来进行事件监听，但是其使用并不是特别方便</p>
<p>​    需要开发人员自己反复注册Watcher，比较繁琐。</p>
<p>•Curator引入了 Cache 来实现对 ZooKeeper 服务端事件的监听。</p>
<p>•ZooKeeper提供了三种Watcher：</p>
<p>•NodeCache : 只是监听某一个特定的节点</p>
<p>•PathChildrenCache : 监控一个ZNode的子节点. </p>
<p>•TreeCache : 可以监控整个树上的所有节点，类似于PathChildrenCache和NodeCache的组合</p>
<p><img alt="1592057429708" src="assets\1592057429708.png" /></p>
<h3 id="48zookeeper_javaapi-watch-nodecache">4.8Zookeeper JavaAPI操作-Watch监听-NodeCache<a class="headerlink" href="#48zookeeper_javaapi-watch-nodecache" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm">* 演示 NodeCache：给指定一个节点注册监听器</span>
<span class="cm">*/</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testNodeCache</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="c1">//1. 创建NodeCache对象</span>
    <span class="kd">final</span> <span class="n">NodeCache</span> <span class="n">nodeCache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NodeCache</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="s">&quot;/app1&quot;</span><span class="p">);</span>
    <span class="c1">//2. 注册监听</span>
    <span class="n">nodeCache</span><span class="p">.</span><span class="na">getListenable</span><span class="p">().</span><span class="na">addListener</span><span class="p">(</span><span class="k">new</span> <span class="n">NodeCacheListener</span><span class="p">()</span> <span class="p">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">nodeChanged</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;节点变化了~&quot;</span><span class="p">);</span>
            <span class="c1">//获取修改节点后的数据</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="n">nodeCache</span><span class="p">.</span><span class="na">getCurrentData</span><span class="p">().</span><span class="na">getData</span><span class="p">();</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="k">new</span> <span class="n">String</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">});</span>
        <span class="c1">//3. 开启监听.如果设置为true，则开启监听是，加载缓冲数据</span>
        <span class="n">nodeCache</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">){</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="49zookeeper_javaapi-watch-pathchildrencache"><strong>4.9)Zookeeper</strong> JavaAPI操作-Watch监听-PathChildrenCache<a class="headerlink" href="#49zookeeper_javaapi-watch-pathchildrencache" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testPathChildrenCache</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="c1">//1.创建监听对象</span>
    <span class="n">PathChildrenCache</span> <span class="n">pathChildrenCache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PathChildrenCache</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="s">&quot;/app2&quot;</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
    <span class="c1">//2. 绑定监听器</span>
    <span class="n">pathChildrenCache</span><span class="p">.</span><span class="na">getListenable</span><span class="p">().</span><span class="na">addListener</span><span class="p">(</span><span class="k">new</span> <span class="n">PathChildrenCacheListener</span><span class="p">()</span> <span class="p">{</span>             <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">childEvent</span><span class="p">(</span><span class="n">CuratorFramework</span> <span class="n">client</span><span class="p">,</span> <span class="n">PathChildrenCacheEvent</span> <span class="n">event</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;子节点变化了~&quot;</span><span class="p">);</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
            <span class="c1">//监听子节点的数据变更，并且拿到变更后的数据</span>
            <span class="c1">//1.获取类型</span>
            <span class="n">PathChildrenCacheEvent</span><span class="p">.</span><span class="na">Type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="na">getType</span><span class="p">();</span>
            <span class="c1">//2.判断类型是否是update</span>
            <span class="k">if</span><span class="p">(</span><span class="n">type</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">PathChildrenCacheEvent</span><span class="p">.</span><span class="na">Type</span><span class="p">.</span><span class="na">CHILD_UPDATED</span><span class="p">)){</span>
                <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;数据变了！！！&quot;</span><span class="p">);</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="na">getData</span><span class="p">().</span><span class="na">getData</span><span class="p">();</span>
                <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="k">new</span> <span class="n">String</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="c1">//3. 开启</span>
    <span class="n">pathChildrenCache</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
    <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">){</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="410zookeeper_javaapi-watch-treecache"><strong>4.10)Zookeeper</strong> JavaAPI操作-Watch监听-TreeCache<a class="headerlink" href="#410zookeeper_javaapi-watch-treecache" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm">* 演示 TreeCache：监听某个节点自己和所有子节点们</span>
<span class="cm">*/</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testTreeCache</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
    <span class="c1">//1. 创建监听器</span>
    <span class="n">TreeCache</span> <span class="n">treeCache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TreeCache</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="s">&quot;/app2&quot;</span><span class="p">);</span>
    <span class="c1">//2. 注册监听</span>
    <span class="n">treeCache</span><span class="p">.</span><span class="na">getListenable</span><span class="p">().</span><span class="na">addListener</span><span class="p">(</span><span class="k">new</span> <span class="n">TreeCacheListener</span><span class="p">()</span> <span class="p">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">childEvent</span><span class="p">(</span><span class="n">CuratorFramework</span> <span class="n">client</span><span class="p">,</span> <span class="n">TreeCacheEvent</span> <span class="n">event</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;节点变化了&quot;</span><span class="p">);</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="c1">//3. 开启</span>
    <span class="n">treeCache</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
    <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">){</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="411zookeeper-">4.11)Zookeeper分布式锁-概念<a class="headerlink" href="#411zookeeper-" title="Permanent link">&para;</a></h3>
<p>•在我们进行单机应用开发，涉及并发同步的时候，我们往往采用synchronized或者Lock的方式来解决多线程间的代码同步问题，这时多线程的运行都是在同一个JVM之下，没有任何问题。</p>
<p>•但当我们的应用是分布式集群工作的情况下，属于多JVM下的工作环境，跨JVM之间已经无法通过多线程的锁解决同步问题。</p>
<p>•那么就需要一种更加高级的锁机制，来处理种跨机器的进程之间的数据同步问题——这就是分布式锁。</p>
<p><img alt="1592057871141" src="assets\1592057871141.png" /></p>
<h3 id="412zookeeper_-zookeeper"><strong>4.12)Zookeeper</strong> 分布式锁-zookeeper分布式锁原理<a class="headerlink" href="#412zookeeper_-zookeeper" title="Permanent link">&para;</a></h3>
<p>•核心思想：当客户端要获取锁，则创建节点，使用完锁，则删除该节点。</p>
<p>1.客户端获取锁时，在lock节点下创建临时顺序节点。</p>
<p>2.然后获取lock下面的所有子节点，客户端获取到所有的子节点之后，如果发现自己创建的子节点序号最小，那么就认为该客户端获取到了锁。使用完锁后，将该节点删除。</p>
<p>3.如果发现自己创建的节点并非lock所有子节点中最小的，说明自己还没有获取到锁，此时客户端需要找到比自己小的那个节点，同时对其注册事件监听器，监听删除事件。</p>
<p>4.如果发现比自己小的那个节点被删除，则客户端的</p>
<p>​    Watcher会收到相应通知，此时再次判断自己创建的节点</p>
<p>​    是否是lock子节点中序号最小的，如果是则获取到了锁，</p>
<p>​    如果不是则重复以上步骤继续获取到比自己小的一个节点</p>
<p>​    并注册监听。</p>
<p><img alt="1592057925831" src="assets\1592057925831.png" /></p>
<h3 id="413zookeeper_-12306"><strong>4.13)Zookeeper</strong> 分布式锁-模拟12306售票案例<a class="headerlink" href="#413zookeeper_-12306" title="Permanent link">&para;</a></h3>
<p><strong>Curator实现分布式锁API</strong></p>
<ul>
<li>
<p>在Curator中有五种锁方案：</p>
</li>
<li>
<p>InterProcessSemaphoreMutex：分布式排它锁（非可重入锁）</p>
</li>
<li>
<p>InterProcessMutex：分布式可重入排它锁</p>
</li>
<li>
<p>InterProcessReadWriteLock：分布式读写锁</p>
</li>
<li>
<p>InterProcessMultiLock：将多个锁作为单个实体管理的容器</p>
</li>
<li>
<p>InterProcessSemaphoreV2：共享信号量</p>
</li>
</ul>
<p><img alt="1592058017457" src="assets\1592058017457.png" /></p>
<p>1,创建线程进行加锁设置</p>
<div class="codehilite"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Ticket12306</span> <span class="kd">implements</span> <span class="n">Runnable</span><span class="p">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">tickets</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span><span class="c1">//数据库的票数</span>
    <span class="kd">private</span> <span class="n">InterProcessMutex</span> <span class="n">lock</span> <span class="p">;</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="kc">true</span><span class="p">){</span>
            <span class="c1">//获取锁</span>
            <span class="k">try</span> <span class="p">{</span>
            <span class="n">lock</span><span class="p">.</span><span class="na">acquire</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="n">tickets</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
                    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">()</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="n">tickets</span><span class="p">);</span>
                    <span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
                    <span class="n">tickets</span><span class="o">--</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
            <span class="p">}</span><span class="k">finally</span> <span class="p">{</span>
                <span class="c1">//释放锁</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="n">lock</span><span class="p">.</span><span class="na">release</span><span class="p">();</span>
                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span>
                <span class="p">}</span>

            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>2,创建连接，并且初始化锁</p>
<div class="codehilite"><pre><span></span><code><span class="kd">public</span> <span class="nf">Ticket12306</span><span class="p">(){</span>
    <span class="c1">//重试策略</span>
    <span class="n">RetryPolicy</span> <span class="n">retryPolicy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ExponentialBackoffRetry</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="c1">//2.第二种方式</span>
    <span class="c1">//CuratorFrameworkFactory.builder();</span>
    <span class="n">CuratorFramework</span> <span class="n">client</span> <span class="o">=</span> <span class="n">CuratorFrameworkFactory</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
        <span class="p">.</span><span class="na">connectString</span><span class="p">(</span><span class="s">&quot;192.168.149.135:2181&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="na">sessionTimeoutMs</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="p">.</span><span class="na">connectionTimeoutMs</span><span class="p">(</span><span class="mi">15</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="p">.</span><span class="na">retryPolicy</span><span class="p">(</span><span class="n">retryPolicy</span><span class="p">)</span>
        <span class="p">.</span><span class="na">build</span><span class="p">();</span>
    <span class="c1">//开启连接</span>
    <span class="n">client</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
    <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InterProcessMutex</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="s">&quot;/lock&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>3,运行多个线程进行测试</p>
<div class="codehilite"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LockTest</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Ticket12306</span> <span class="n">ticket12306</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Ticket12306</span><span class="p">();</span>
        <span class="c1">//创建客户端</span>
        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="n">ticket12306</span><span class="p">,</span><span class="s">&quot;携程&quot;</span><span class="p">);</span>
        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="n">ticket12306</span><span class="p">,</span><span class="s">&quot;飞猪&quot;</span><span class="p">);</span>
        <span class="n">t1</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
        <span class="n">t2</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="5zookeeper">5)ZooKeeper 集群搭建<a class="headerlink" href="#5zookeeper" title="Permanent link">&para;</a></h2>
<h3 id="51zookeeper"><strong>5.1)Zookeeper</strong>集群介绍<a class="headerlink" href="#51zookeeper" title="Permanent link">&para;</a></h3>
<p>Leader选举：</p>
<p>•Serverid：服务器ID</p>
<p>比如有三台服务器，编号分别是1,2,3。</p>
<p>编号越大在选择算法中的权重越大。</p>
<p>•Zxid：数据ID</p>
<p>服务器中存放的最大数据ID.值越大说明数据  越新，在选举算法中数据越新权重越大。</p>
<p>•在Leader选举的过程中，如果某台ZooKeeper</p>
<p>​    获得了超过半数的选票，</p>
<p>​    则此ZooKeeper就可以成为Leader了。</p>
<h3 id="52">5.2)搭建要求<a class="headerlink" href="#52" title="Permanent link">&para;</a></h3>
<p>真实的集群是需要部署在不同的服务器上的，但是在我们测试时同时启动很多个虚拟机内存会吃不消，所以我们通常会搭建<strong>伪集群</strong>，也就是把所有的服务都搭建在一台虚拟机上，用端口进行区分。</p>
<p>我们这里要求搭建一个三个节点的Zookeeper集群（伪集群）。</p>
<h3 id="53"><strong>5.3)准备工作</strong><a class="headerlink" href="#53" title="Permanent link">&para;</a></h3>
<p>重新部署一台虚拟机作为我们搭建集群的测试服务器。</p>
<p>（1）安装JDK  【此步骤省略】。</p>
<p>（2）Zookeeper压缩包上传到服务器
（3）将Zookeeper解压 ，建立/usr/local/zookeeper-cluster目录，将解压后的Zookeeper复制到以下三个目录</p>
<p>/usr/local/zookeeper-cluster/zookeeper-1</p>
<p>/usr/local/zookeeper-cluster/zookeeper-2</p>
<p>/usr/local/zookeeper-cluster/zookeeper-3</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># mkdir /usr/local/zookeeper-cluster</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># cp -r  apache-zookeeper-3.5.6-bin /usr/local/zookeeper-cluster/zookeeper-1</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># cp -r  apache-zookeeper-3.5.6-bin /usr/local/zookeeper-cluster/zookeeper-2</span>
<span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># cp -r  apache-zookeeper-3.5.6-bin /usr/local/zookeeper-cluster/zookeeper-3</span>
</code></pre></div>

<p>（4）创建data目录 ，并且将 conf下zoo_sample.cfg 文件改名为 zoo.cfg</p>
<div class="codehilite"><pre><span></span><code>mkdir /usr/local/zookeeper-cluster/zookeeper-1/data
mkdir /usr/local/zookeeper-cluster/zookeeper-2/data
mkdir /usr/local/zookeeper-cluster/zookeeper-3/data

mv  /usr/local/zookeeper-cluster/zookeeper-1/conf/zoo_sample.cfg  /usr/local/zookeeper-cluster/zookeeper-1/conf/zoo.cfg
mv  /usr/local/zookeeper-cluster/zookeeper-2/conf/zoo_sample.cfg  /usr/local/zookeeper-cluster/zookeeper-2/conf/zoo.cfg
mv  /usr/local/zookeeper-cluster/zookeeper-3/conf/zoo_sample.cfg  /usr/local/zookeeper-cluster/zookeeper-3/conf/zoo.cfg
</code></pre></div>

<p>（5） 配置每一个Zookeeper 的dataDir 和 clientPort 分别为2181  2182  2183</p>
<p>修改/usr/local/zookeeper-cluster/zookeeper-1/conf/zoo.cfg</p>
<div class="codehilite"><pre><span></span><code>vim /usr/local/zookeeper-cluster/zookeeper-1/conf/zoo.cfg

<span class="nv">clientPort</span><span class="o">=</span><span class="m">2181</span>
<span class="nv">dataDir</span><span class="o">=</span>/usr/local/zookeeper-cluster/zookeeper-1/data
</code></pre></div>

<p>修改/usr/local/zookeeper-cluster/zookeeper-2/conf/zoo.cfg</p>
<div class="codehilite"><pre><span></span><code>vim /usr/local/zookeeper-cluster/zookeeper-2/conf/zoo.cfg

<span class="nv">clientPort</span><span class="o">=</span><span class="m">2182</span>
<span class="nv">dataDir</span><span class="o">=</span>/usr/local/zookeeper-cluster/zookeeper-2/data
</code></pre></div>

<p>修改/usr/local/zookeeper-cluster/zookeeper-3/conf/zoo.cfg</p>
<div class="codehilite"><pre><span></span><code>vim /usr/local/zookeeper-cluster/zookeeper-3/conf/zoo.cfg

<span class="nv">clientPort</span><span class="o">=</span><span class="m">2183</span>
<span class="nv">dataDir</span><span class="o">=</span>/usr/local/zookeeper-cluster/zookeeper-3/data
</code></pre></div>

<h3 id="54"><strong>5.4)配置集群</strong><a class="headerlink" href="#54" title="Permanent link">&para;</a></h3>
<p>（1）在每个zookeeper的 data 目录下创建一个 myid 文件，内容分别是1、2、3 。这个文件就是记录每个服务器的ID</p>
<div class="codehilite"><pre><span></span><code><span class="nb">echo</span> <span class="m">1</span> &gt;/usr/local/zookeeper-cluster/zookeeper-1/data/myid
<span class="nb">echo</span> <span class="m">2</span> &gt;/usr/local/zookeeper-cluster/zookeeper-2/data/myid
<span class="nb">echo</span> <span class="m">3</span> &gt;/usr/local/zookeeper-cluster/zookeeper-3/data/myid
</code></pre></div>

<p>（2）在每一个zookeeper 的 zoo.cfg配置客户端访问端口（clientPort）和集群服务器IP列表。</p>
<p>集群服务器IP列表如下</p>
<div class="codehilite"><pre><span></span><code>vim /usr/local/zookeeper-cluster/zookeeper-1/conf/zoo.cfg
vim /usr/local/zookeeper-cluster/zookeeper-2/conf/zoo.cfg
vim /usr/local/zookeeper-cluster/zookeeper-3/conf/zoo.cfg

server.1<span class="o">=</span><span class="m">192</span>.168.149.135:2881:3881
server.2<span class="o">=</span><span class="m">192</span>.168.149.135:2882:3882
server.3<span class="o">=</span><span class="m">192</span>.168.149.135:2883:3883
</code></pre></div>

<p>解释：server.服务器ID=服务器IP地址：服务器之间通信端口：服务器之间投票选举端口</p>
<h3 id="55"><strong>5.5)启动集群</strong><a class="headerlink" href="#55" title="Permanent link">&para;</a></h3>
<p>启动集群就是分别启动每个实例。</p>
<div class="codehilite"><pre><span></span><code>/usr/local/zookeeper-cluster/zookeeper-1/bin/zkServer.sh start
/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh start
/usr/local/zookeeper-cluster/zookeeper-3/bin/zkServer.sh start
</code></pre></div>

<p><img alt="img" src="assets\/wps11.jpg" /> </p>
<p>启动后我们查询一下每个实例的运行状态</p>
<div class="codehilite"><pre><span></span><code>/usr/local/zookeeper-cluster/zookeeper-1/bin/zkServer.sh status
/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh status
/usr/local/zookeeper-cluster/zookeeper-3/bin/zkServer.sh status
</code></pre></div>

<p>先查询第一个服务</p>
<p><img alt="img" src="assets\/wps12.jpg" /> </p>
<p>Mode为follower表示是<strong>跟随者</strong>（从）</p>
<p>再查询第二个服务Mod 为leader表示是<strong>领导者</strong>（主）</p>
<p><img alt="img" src="assets\wps13.jpg" /> </p>
<p>查询第三个为跟随者（从）</p>
<p><img alt="img" src="assets\wps14.jpg" /> </p>
<h3 id="56"><strong>5.6)模拟集群异常</strong><a class="headerlink" href="#56" title="Permanent link">&para;</a></h3>
<p>（1）首先我们先测试如果是从服务器挂掉，会怎么样</p>
<p>把3号服务器停掉，观察1号和2号，发现状态并没有变化</p>
<div class="codehilite"><pre><span></span><code>/usr/local/zookeeper-cluster/zookeeper-3/bin/zkServer.sh stop

/usr/local/zookeeper-cluster/zookeeper-1/bin/zkServer.sh status
/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh status
</code></pre></div>

<p><img alt="img" src="assets\wps15.jpg" /> </p>
<p>由此得出结论，3个节点的集群，从服务器挂掉，集群正常</p>
<p>（2）我们再把1号服务器（从服务器）也停掉，查看2号（主服务器）的状态，发现已经停止运行了。</p>
<div class="codehilite"><pre><span></span><code>/usr/local/zookeeper-cluster/zookeeper-1/bin/zkServer.sh stop

/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh status
</code></pre></div>

<p><img alt="img" src="assets\wps16.jpg" /> </p>
<p>由此得出结论，3个节点的集群，2个从服务器都挂掉，主服务器也无法运行。因为可运行的机器没有超过集群总数量的半数。</p>
<p>（3）我们再次把1号服务器启动起来，发现2号服务器又开始正常工作了。而且依然是领导者。</p>
<div class="codehilite"><pre><span></span><code>/usr/local/zookeeper-cluster/zookeeper-1/bin/zkServer.sh start

/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh status
</code></pre></div>

<p><img alt="img" src="assets\wps17.jpg" /> </p>
<p>（4）我们把3号服务器也启动起来，把2号服务器停掉,停掉后观察1号和3号的状态。</p>
<div class="codehilite"><pre><span></span><code>/usr/local/zookeeper-cluster/zookeeper-3/bin/zkServer.sh start
/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh stop

/usr/local/zookeeper-cluster/zookeeper-1/bin/zkServer.sh status
/usr/local/zookeeper-cluster/zookeeper-3/bin/zkServer.sh status
</code></pre></div>

<p><img alt="img" src="assets\wps18.jpg" /> </p>
<p>发现新的leader产生了~  </p>
<p>由此我们得出结论，当集群中的主服务器挂了，集群中的其他服务器会自动进行选举状态，然后产生新得leader </p>
<p>（5）我们再次测试，当我们把2号服务器重新启动起来启动后，会发生什么？2号服务器会再次成为新的领导吗？我们看结果</p>
<div class="codehilite"><pre><span></span><code>/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh start

/usr/local/zookeeper-cluster/zookeeper-2/bin/zkServer.sh status
/usr/local/zookeeper-cluster/zookeeper-3/bin/zkServer.sh status
</code></pre></div>

<p><img alt="img" src="assets\wps19.jpg" /><img alt="img" src="assets\wps20.jpg" /> </p>
<p>我们会发现，2号服务器启动后依然是跟随者（从服务器），3号服务器依然是领导者（主服务器），没有撼动3号服务器的领导地位。</p>
<p>由此我们得出结论，当领导者产生后，再次有新服务器加入集群，不会影响到现任领导者。</p>
<h2 id="6zookeeper">6)Zookeeper 核心理论<a class="headerlink" href="#6zookeeper" title="Permanent link">&para;</a></h2>
<p><strong>Zookeepe集群角色</strong></p>
<p>在ZooKeeper集群服中务中有三个角色：</p>
<p>•Leader 领导者 ：          </p>
<p>​   1. 处理事务请求</p>
<p>​   2. 集群内部各服务器的调度者</p>
<p>•Follower 跟随者 ：</p>
<p>​   1. 处理客户端非事务请求，转发事务请求给Leader服务器</p>
<p>​   2. 参与Leader选举投票</p>
<p>•Observer 观察者：</p>
<div class="codehilite"><pre><span></span><code><span class="mf">1.</span> <span class="n">处理客户端非事务请求</span><span class="err">，</span><span class="n">转发事务请求给Leader服务器</span>
</code></pre></div>

<p><img alt="1592058451822" src="assets\1592058451822.png" /></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; 2019 peaceiris
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/peaceiris" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/piris314en" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["tabs"], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.477d984a.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.82b56eb2.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>